<div class="container">
  <h1>Weekly Meal Plan</h1>
  
  <% if notice %>
    <div class="alert alert-success"><%= notice %></div>
  <% end %>
  <% if alert %>
    <div class="alert alert-danger"><%= alert %></div>
  <% end %>

  <table class="table meal-plan-table">
    <% @days.each do |day| %>
      <tr>
        <td><%= day.strftime('%A, %b %d') %></td>
        <% @meal_types.each do |meal_type| %>
          <td>
            <% meal_plan = current_user.meal_plans
                             .joins(:meal)
                             .find_by(date: day, meals: { meal_type: meal_type }) %>
            
            <%= form_with url: update_plan_meal_plans_path, method: :post do |f| %>
              <%= f.hidden_field :date, value: day %>
              <%= f.hidden_field :meal_type, value: meal_type %>
              
              <%= f.select :meal_id,
                  options_for_select(
                    [['Select meal...', '']] + 
                    (@meals_by_type[meal_type] || []).map { |m| [m.name, m.id] },
                    meal_plan&.meal_id
                  ),
                  {},
                  class: 'form-control meal-select',
                  onchange: 'this.form.submit()'
              %>
            <% end %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.meal-select').forEach(select => {
    select.addEventListener('change', function() {
      this.disabled = true;
      const spinner = document.createElement('span');
      spinner.className = 'spinner';
      spinner.textContent = 'Saving...';
      this.parentNode.insertBefore(spinner, this.nextSibling);
      
      // Remove spinner after 3 seconds if still there
      setTimeout(() => {
        if (spinner.parentNode) spinner.remove();
      }, 3000);
    });
  });
});
</script>