<%= form_with(model: pantry_item) do |form| %>
  <% if pantry_item.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(pantry_item.errors.count, "error") %> prohibited this pantry_item from being saved:</h2>

      <ul>
        <% pantry_item.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.hidden_field :name %>
  </div>

  <div>
    <%= form.hidden_field :barcode, id: "barcode-result" %>
  </div>

  <div>
    <%= form.hidden_field :user_id, value: current_user.id %>
  </div>

  <%= image_tag "camera-icon.svg", alt: "Camera icon", class: "camera-icon"%>
  
  <video id="scanner-video"></video>

  <script>
    document.addEventListener('DOMContentLoaded', initScanner);

    function initScanner() {
      // Check if we're on the right page (has scanner elements)
      const videoElem = document.getElementById('scanner-video');
      const barcodeInput = document.getElementById('barcode-result');
      
      if (!videoElem || !barcodeInput) return;
      
      console.log("Scanner elements found, initializing camera...");
      
      // Ensure ZXing is loaded
      if (typeof ZXing === 'undefined') {
        console.error("ZXing library not loaded! Please check script inclusion.");
        return;
      }
      
      // Initialize scanner
      const codeReader = new ZXing.BrowserMultiFormatReader();
      // Show video element
      videoElem.style.display = 'block';
      
      // Start camera immediately
      codeReader.decodeFromVideoDevice(null, videoElem, (result) => {
        if (result) {
          console.log("Barcode detected:", result.text);
          barcodeInput.value = result.text;
          codeReader.reset();
          videoElem.style.display = 'none';
          
          // Find and click the submit button instead of submitting directly
          const submitButton = document.querySelector("input[type='submit']");
          if (submitButton) {
            submitButton.click();
          }
        }
      }).catch(err => {
        console.error("Camera error:", err);
      });
      
      // Set up cleanup for when leaving page
      const backLink = document.getElementById("custom-link");
      if (backLink) {
        backLink.addEventListener("click", () => {
          console.log("Back link clicked, stopping camera");
          codeReader.reset();
          videoElem.style.display = 'none';
        });
      }      
    }
  </script>

  <div>
    <%= form.submit class: "hidden-submit" %>
  </div>
  <div class="floating-button-container">
    <%= link_to pantry_items_path, id: "custom-link", class: "floating-action-button" do %>
        <%= image_tag "arrow-left.svg", alt: "Back to pantry items", class: "floating-button-icon" %>
    <% end %>

  </div>
<% end %>
